@hostname = localhost
@port = 5525
@host = http://{{hostname}}:{{port}}
@contentType = application/json

# Auto-generate unique email each run for isolation
@unique = {{$timestamp}}
@email = tester_{{unique}}@gameservice.com
@password = Test123!ABC


### Health Check
GET {{host}}/health

> {%
    client.test("Health endpoint online", function () {
        client.assert(response.status === 200, "Service not healthy");
    });
%}


### Register User
POST {{host}}/auth/register
Content-Type: {{contentType}}

{
  "email": "{{email}}",
  "password": "{{password}}"
}

> {%
    if (response.status === 200) {
        client.log(`ğŸ†• Registered: {{email}}`);
    } else if (response.status === 400) {
        client.log(`â„¹ï¸ Already Exists: {{email}}`);
    } else {
        client.log("âŒ Unexpected register status: " + response.status);
    }

    client.test("Register status valid", function () {
        client.assert(
            response.status === 200 || response.status === 400,
            "Register should be either success OR already exists"
        );
    });
%}


### Login
POST {{host}}/auth/login
Content-Type: {{contentType}}

{
  "email": "{{email}}",
  "password": "{{password}}"
}

> {%
    client.test("Login should be successful", function () {
        client.assert(response.status === 200, "Login failed");
    });

    // Token validation
    client.test("AccessToken exists", function() {
        client.assert(typeof response.body.accessToken === "string", "No access token returned");
    });

    client.global.set("auth_token", response.body.accessToken);
    client.log("ğŸ” Token stored");
%}


### Get Profile
GET {{host}}/game/me
Authorization: Bearer {{auth_token}}

> {%
    client.test("Profile endpoint works", function () {
        client.assert(response.status === 200, "Expected 200");
    });

    const coins = response.body.coins;
    client.global.set("starting_coins", coins);

    client.test("Coins should be number", function() {
        client.assert(typeof coins === "number", "Coins not number");
    });

    client.log("ğŸ’° Starting coins = " + coins);
%}


### Earn Coins
POST {{host}}/game/coins/transaction
Authorization: Bearer {{auth_token}}
Content-Type: {{contentType}}

{
  "amount": 50
}

> {%
    const before = Number(client.global.get("starting_coins"));
    const after = response.body.newBalance;
    const expected = before + 50;

    client.log(`ğŸ“ˆ Before=${before}, After=${after}, Expected=${expected}`);

    client.test("Status OK", function () {
        client.assert(response.status === 200, "Transaction failed");
    });

    client.test("Balance increased correctly", function () {
        client.assert(after === expected, `Incorrect balance; expected ${expected}, got ${after}`);
    });
%}


### Re-check Profile To Ensure Balance Persisted
GET {{host}}/game/me
Authorization: Bearer {{auth_token}}

> {%
    const expected = Number(client.global.get("starting_coins")) + 50;
    const actual = response.body.coins;

    client.test("Profile balance matches transaction result", function () {
        client.assert(actual === expected, `Profile coins mismatch. Expected: ${expected}, Got: ${actual}`);
    });

    client.log("ğŸ”„ Balance verification OK: " + actual);
%}

### INVALID: Earn Negative Coins
POST {{host}}/game/coins/transaction
Authorization: Bearer {{auth_token}}
Content-Type: {{contentType}}

{
  "amount": -999
}

> {%
    client.test("Should reject negative amounts", function () {
        client.assert(response.status === 400, "Negative coin not rejected");
    });
%}
