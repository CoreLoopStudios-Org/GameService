@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using GameService.Ludo
@inject GameService.Web.Services.GameAdminService AdminService

<div class="row">
    <!-- Visualization Column (Same as before) -->
    <div class="col-md-8">
        <!-- ... Visualization Code ... -->
         <div class="card mb-4">
            <div class="card-header bg-dark text-white">State</div>
            <div class="card-body">
                <p>Current Turn: Seat @Game.State.CurrentPlayer</p>
                <p>Last Dice: @Game.State.LastDiceRoll</p>
            </div>
        </div>
    </div>

    <!-- Controls Column -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">God Mode Controls</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    Actions here are performed by the SERVER on behalf of whoever's turn it is. 
                    All players will see the move happen.
                </p>
                
                <hr />

                <h6>1. Roll Dice</h6>
                <button class="btn btn-warning w-100 mb-3" @onclick="DoForceRoll" disabled="@(isBusy || Game.State.LastDiceRoll != 0)">
                    @if(isBusy) { <span class="spinner-border spinner-border-sm"></span> }
                    Force Roll
                </button>
                
                <h6>2. Move Token</h6>
                <div class="d-grid gap-2 d-md-block">
                    @for (int i = 0; i < 4; i++)
                    {
                        var tIdx = i;
                        <button class="btn btn-outline-danger me-1 mb-1" 
                                @onclick="() => DoForceMove(tIdx)"
                                disabled="@(isBusy || Game.State.LastDiceRoll == 0)">
                            Token @tIdx
                        </button>
                    }
                </div>

                <hr />
                <button class="btn btn-secondary w-100" @onclick="OnRefresh">Refresh State</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public required LudoContext Game { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    
    private bool isBusy = false;

    private async Task DoForceRoll()
    {
        isBusy = true;
        try 
        {
            await AdminService.PlayLudoRollAsync(Game.RoomId);
            await OnRefresh.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally { isBusy = false; }
    }

    private async Task DoForceMove(int tokenIndex)
    {
        isBusy = true;
        try 
        {
            await AdminService.PlayLudoMoveAsync(Game.RoomId, tokenIndex);
            await OnRefresh.InvokeAsync();
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error: {ex.Message}");
        }
        finally { isBusy = false; }
    }
}