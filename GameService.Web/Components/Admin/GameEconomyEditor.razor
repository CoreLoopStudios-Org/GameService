@using GameService.Web.Services
@inject GameAdminService AdminService
@inject ToastService Toast

<div class="card mt-3">
    <div class="card-header">
        <h3>Economy Settings for @GameType</h3>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" id="economyTabs-@GameType" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == TabOnboarding ? "active" : "")" id="onboarding-tab-@GameType" type="button" role="tab" @onclick="() => SetTab(TabOnboarding)">Onboarding</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == TabDaily ? "active" : "")" id="daily-tab-@GameType" type="button" role="tab" @onclick="() => SetTab(TabDaily)">Daily Rewards</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == TabSpin ? "active" : "")" id="spin-tab-@GameType" type="button" role="tab" @onclick="() => SetTab(TabSpin)">Spin Wheel</button>
            </li>
        </ul>
        <div class="tab-content p-3 border border-top-0" id="economyTabsContent-@GameType">
            <!-- Onboarding -->
            <div class="tab-pane fade @(activeTab == TabOnboarding ? "show active" : "")" id="onboarding-@GameType" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label">Welcome Bonus (Coins)</label>
                    <input type="number" class="form-control" @bind="EconomyConfig.WelcomeBonus" />
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="EconomyConfig.DailyEnabled" id="dailyEnabled-@GameType">
                    <label class="form-check-label" for="dailyEnabled-@GameType">Enable Daily Rewards System</label>
                </div>
                <button class="btn btn-primary" @onclick="SaveEconomy"><i class="bi bi-save"></i> Save Onboarding</button>
            </div>

            <!-- Daily Rewards -->
            <div class="tab-pane fade @(activeTab == TabDaily ? "show active" : "")" id="daily-@GameType" role="tabpanel">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="DailyConfig.Enabled" id="dailyRewardsEnabled-@GameType">
                    <label class="form-check-label" for="dailyRewardsEnabled-@GameType">Enable Daily Rewards</label>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Jackpot?</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var reward in DailyConfig.Rewards.OrderBy(r => r.Day))
                        {
                            <tr>
                                <td><input type="number" class="form-control form-control-sm" value="@reward.Day" disabled /></td>
                                <td><input type="number" class="form-control form-control-sm" @bind="reward.Amount" /></td>
                                <td><input type="text" class="form-control form-control-sm" @bind="reward.Type" /></td>
                                <td><input type="checkbox" class="form-check-input" @bind="reward.IsJackpot" /></td>
                                <td><button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveDailyReward(reward)"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>
                <button class="btn btn-outline-secondary mb-3" @onclick="AddDailyReward"><i class="bi bi-plus-lg"></i> Add Day</button>
                <br/>
                <button class="btn btn-primary" @onclick="SaveDaily"><i class="bi bi-save"></i> Save Daily Rewards</button>
            </div>

            <!-- Spin Wheel -->
            <div class="tab-pane fade @(activeTab == TabSpin ? "show active" : "")" id="spin-@GameType" role="tabpanel">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="SpinConfig.Enabled" id="spinEnabled-@GameType">
                    <label class="form-check-label" for="spinEnabled-@GameType">Enable Spin Wheel</label>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Cost Per Spin</label>
                        <input type="number" class="form-control" @bind="SpinConfig.CostPerSpin" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Free Spins Per Day</label>
                        <input type="number" class="form-control" @bind="SpinConfig.FreeSpinsPerDay" />
                    </div>
                </div>

                <label class="form-label fw-bold">Wheel Segments</label>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Amount</th>
                            <th>Weight</th>
                            <th>Color</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var segment in SpinConfig.Segments)
                        {
                            <tr>
                                <td><input type="text" class="form-control form-control-sm" @bind="segment.Label" placeholder="e.g. 100 Coins" /></td>
                                <td><input type="number" class="form-control form-control-sm" @bind="segment.Amount" /></td>
                                <td><input type="number" class="form-control form-control-sm" @bind="segment.Weight" /></td>
                                <td><input type="color" class="form-control form-control-sm form-control-color" @bind="segment.Color" /></td>
                                <td><button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveSpinSegment(segment)"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>

                <button class="btn btn-outline-secondary mb-3" @onclick="AddSpinSegment"><i class="bi bi-plus-lg"></i> Add Segment</button>
                <br/>
                <button class="btn btn-primary" @onclick="SaveSpin"><i class="bi bi-save"></i> Save Spin Wheel</button>

                <div class="mt-4 border-top pt-3">
                    <h6>Preview</h6>
                    <SpinWheelPreview Segments="@SpinConfig.Segments" />
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string GameType { get; set; } = "Ludo";

    private GameEconomyConfig EconomyConfig { get; set; } = new();
    private DailyRewardsWrapper DailyConfig { get; set; } = new();
    private SpinWheelConfig SpinConfig { get; set; } = new();

    private const string TabOnboarding = "onboarding";
    private const string TabDaily = "daily";
    private const string TabSpin = "spin";

    private string activeTab = TabOnboarding;

    protected override async Task OnParametersSetAsync()
    {
        activeTab = TabOnboarding;
        await LoadData();
    }

    private async Task LoadData()
    {
        EconomyConfig = await AdminService.GetGameEconomyConfigAsync(GameType);
        DailyConfig = await AdminService.GetDailyRewardsConfigAsync(GameType);
        SpinConfig = await AdminService.GetSpinWheelConfigAsync(GameType);
    }

    private void SetTab(string tab) => activeTab = tab;

    private async Task SaveEconomy()
    {
        await AdminService.SaveGameEconomyConfigAsync(GameType, EconomyConfig);
        Toast.ShowSuccess("Economy settings saved");
    }

    private async Task SaveDaily()
    {
        RenumberDailyRewards();
        await AdminService.SaveDailyRewardsConfigAsync(GameType, DailyConfig);
        Toast.ShowSuccess("Daily rewards saved");
    }

    private void AddDailyReward()
    {
        RenumberDailyRewards();
        var nextDay = DailyConfig.Rewards.Count + 1;
        DailyConfig.Rewards.Add(new DailyRewardConfig { Day = nextDay, Amount = 100 });
    }

    private void RemoveDailyReward(DailyRewardConfig reward)
    {
        DailyConfig.Rewards.Remove(reward);
        RenumberDailyRewards();
    }

    private void RenumberDailyRewards()
    {
        DailyConfig.Rewards = DailyConfig.Rewards.OrderBy(r => r.Day).ToList();
        for (var i = 0; i < DailyConfig.Rewards.Count; i++)
            DailyConfig.Rewards[i].Day = i + 1;
    }

    private async Task SaveSpin()
    {
        await AdminService.SaveSpinWheelConfigAsync(GameType, SpinConfig);
        Toast.ShowSuccess("Spin wheel saved");
    }

    private void AddSpinSegment()
    {
        SpinConfig.Segments.Add(new SpinWheelSegment { Label = "Prize", Amount = 100, Weight = 10, Color = "#444444" });
    }

    private void RemoveSpinSegment(SpinWheelSegment segment)
    {
        SpinConfig.Segments.Remove(segment);
    }
}